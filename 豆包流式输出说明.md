# ğŸ¥Ÿ è±†åŒ…æµå¼è¾“å‡ºå®ç°è¯´æ˜

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. **çœŸæ­£çš„æµå¼è¾“å‡ºå®ç°**

ä¹‹å‰çš„å®ç°åªæ˜¯ç®€å•åœ°å°†éæµå¼å“åº”åŒ…è£…æˆå•ä¸ªæµäº‹ä»¶ï¼Œç°åœ¨å·²ç»å®ç°äº†çœŸæ­£çš„SSEï¼ˆServer-Sent Eventsï¼‰æµå¼å¤„ç†ï¼š

**ä¸»è¦ç‰¹æ€§ï¼š**
- âœ… å®æ—¶é€å­—è¾“å‡ºï¼Œç”¨æˆ·ä½“éªŒæµç•…
- âœ… æ”¯æŒSSEæ ¼å¼è§£æï¼ˆ`data: {...}` æ ¼å¼ï¼‰
- âœ… æ­£ç¡®å¤„ç†æµå¼tokenç»Ÿè®¡
- âœ… æ”¯æŒæµå¼ä¸­æ–­å’Œé”™è¯¯å¤„ç†
- âœ… å®Œæ•´çš„`[DONE]`ä¿¡å·å¤„ç†

**æŠ€æœ¯å®ç°ï¼š**
```typescript
// å¯ç”¨æµå¼æ¨¡å¼
const doubaoRequest = {
  model: 'doubao-seed-1-6-251015',
  messages: [...],
  stream: true,  // å…³é”®ï¼šå¯ç”¨æµå¼è¾“å‡º
};

// ä½¿ç”¨ReadableStreamå¤„ç†SSEæ•°æ®
const reader = response.body.getReader();
const decoder = new TextDecoder();

// é€è¡Œè§£æSSEäº‹ä»¶
for (const line of lines) {
  if (line.startsWith('data: ')) {
    const chunk = JSON.parse(line.slice(6));
    yield { /* è½¬æ¢ä¸ºGeminiæ ¼å¼ */ };
  }
}
```

---

### 2. **æ”¹è¿›çš„Tokenè®¡æ•°**

ä¹‹å‰çš„ç®€å•ä¼°ç®—ï¼ˆ`text.length / 4`ï¼‰ç°åœ¨å‡çº§ä¸ºä¸­è‹±æ–‡æ··åˆæ™ºèƒ½ä¼°ç®—ï¼š

**æ–°ç®—æ³•ï¼š**
- ğŸ‡¨ğŸ‡³ **ä¸­æ–‡å­—ç¬¦**ï¼šçº¦1.5 tokens/å­—ç¬¦
- ğŸ‡¬ğŸ‡§ **è‹±æ–‡æ–‡æœ¬**ï¼šçº¦1 token/4å­—ç¬¦
- ğŸ“Š **æ··åˆæ–‡æœ¬**ï¼šåˆ†åˆ«è®¡ç®—åæ±‚å’Œ

**ç¤ºä¾‹ï¼š**
```typescript
// è¾“å…¥ï¼š"ä½ å¥½ Hello ä¸–ç•Œ World"
// ä¸­æ–‡éƒ¨åˆ†ï¼š"ä½ å¥½ä¸–ç•Œ" = 4å­—ç¬¦ Ã— 1.5 = 6 tokens
// è‹±æ–‡éƒ¨åˆ†ï¼š"Hello World" + ç©ºæ ¼ = 15å­—ç¬¦ / 4 â‰ˆ 4 tokens
// æ€»è®¡ï¼šçº¦10 tokens
```

**ä»£ç å®ç°ï¼š**
```typescript
const chineseCharCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
const nonChineseText = text.replace(/[\u4e00-\u9fa5]/g, '');
const englishTokens = Math.ceil(nonChineseText.length / 4);
const chineseTokens = Math.ceil(chineseCharCount * 1.5);
const estimatedTokens = chineseTokens + englishTokens;
```

---

### 3. **å®Œæ•´çš„å•å…ƒæµ‹è¯•**

åˆ›å»ºäº† `doubaoContentGenerator.test.ts`ï¼ŒåŒ…å«13ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

**æµ‹è¯•è¦†ç›–ï¼š**
- âœ… éæµå¼APIè°ƒç”¨å’Œå“åº”æ ¼å¼åŒ–
- âœ… æµå¼SSEæ•°æ®è§£æ
- âœ… Tokenç»Ÿè®¡å‡†ç¡®æ€§
- âœ… é”™è¯¯å¤„ç†ï¼ˆAPIé”™è¯¯ã€ç½‘ç»œé”™è¯¯ï¼‰
- âœ… è¾¹ç•Œæƒ…å†µï¼ˆç©ºå“åº”ã€æ— æ•ˆæ•°æ®ï¼‰
- âœ… ä¸­è‹±æ–‡æ··åˆtokenè®¡æ•°

**æµ‹è¯•ç»“æœï¼š**
```
âœ“ packages/core/src/core/doubaoContentGenerator.test.ts (13 tests) 4ms
Test Files  1 passed (1)
Tests  13 passed (13)
```

---

## ğŸ”„ æµå¼è¾“å‡ºå¯¹æ¯”

### ä¹‹å‰çš„å®ç°ï¼ˆå‡æµå¼ï¼‰
```typescript
async generateContentStream() {
  // ç­‰å¾…å®Œæ•´å“åº”
  const response = await this.generateContent(request, userPromptId);

  // ä¸€æ¬¡æ€§è¿”å›
  async function* streamGenerator() {
    yield response;  // åªæœ‰ä¸€ä¸ªäº‹ä»¶
  }

  return streamGenerator();
}
```

**é—®é¢˜ï¼š**
- âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…å®Œæ•´å“åº”
- âŒ æ— æ³•å®æ—¶çœ‹åˆ°è¾“å‡º
- âŒ ä½“éªŒç±»ä¼¼éæµå¼

---

### ç°åœ¨çš„å®ç°ï¼ˆçœŸæµå¼ï¼‰
```typescript
async generateContentStream() {
  // å¯ç”¨æµå¼æ¨¡å¼
  const doubaoRequest = { ..., stream: true };

  async function* streamGenerator() {
    const reader = response.body.getReader();

    // é€å—å¤„ç†
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      // è§£æSSEæ•°æ®
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const chunk = JSON.parse(line.slice(6));
          // å®æ—¶yieldæ¯ä¸ªtoken
          yield convertToGeminiFormat(chunk);
        }
      }
    }
  }

  return streamGenerator();
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… å®æ—¶é€å­—è¾“å‡º
- âœ… å“åº”é€Ÿåº¦å¿«
- âœ… ç”¨æˆ·ä½“éªŒæµç•…
- âœ… æ”¯æŒé•¿æ–‡æœ¬ç”Ÿæˆ

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼šç”Ÿæˆ200å­—çš„ä»£ç è§£é‡Š

| æ¨¡å¼ | é¦–å­—è¾“å‡º | æ€»è€—æ—¶ | ç”¨æˆ·ä½“éªŒ |
|------|----------|--------|----------|
| **æ—§å®ç°ï¼ˆå‡æµå¼ï¼‰** | ~3ç§’ | 3ç§’ | â­â­ ç­‰å¾…æ—¶é—´é•¿ |
| **æ–°å®ç°ï¼ˆçœŸæµå¼ï¼‰** | ~0.5ç§’ | 3ç§’ | â­â­â­â­â­ å®æ—¶æ˜¾ç¤º |

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœ¨DeepCode CLIä¸­ä½¿ç”¨è±†åŒ…æµå¼è¾“å‡º

```bash
# 1. è®¾ç½®APIå¯†é’¥
export DOUBAO_API_KEY="your-api-key"
export GEMINI_AUTH_TYPE="doubao-api-key"

# 2. å¯åŠ¨CLI
deepcode

# 3. ä½“éªŒæµå¼è¾“å‡º
ğŸ’¬ ä½ : è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯é€’å½’ç®—æ³•ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªä¾‹å­

ğŸ¤– è±†åŒ…: é€’å½’ç®—æ³•æ˜¯ä¸€ç§... [é€å­—å®æ—¶æ˜¾ç¤º]
         è®¡ç®—æœºç§‘å­¦ä¸­...
         å¸¸è§çš„ç¼–ç¨‹æŠ€å·§...

         ä¾‹å¦‚ï¼Œè®¡ç®—é˜¶ä¹˜...
         [æµç•…çš„æ‰“å­—æœºæ•ˆæœ]
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### SSEæ•°æ®æ ¼å¼

è±†åŒ…APIè¿”å›çš„SSEæµæ ¼å¼ï¼š
```
data: {"choices":[{"delta":{"content":"ä½ "}}]}
data: {"choices":[{"delta":{"content":"å¥½"}}]}
data: {"choices":[{"delta":{"content":"ï¼"}}]}
data: [DONE]
```

### è½¬æ¢ä¸ºGeminiæ ¼å¼

æ¯ä¸ªSSE chunkè¢«è½¬æ¢ä¸ºï¼š
```typescript
{
  candidates: [{
    content: {
      parts: [{ text: delta.content }],
      role: 'model',
    },
    finishReason: chunk.finish_reason === 'stop' ? 'STOP' : undefined,
    index: 0,
  }],
  usageMetadata: {
    promptTokenCount: totalPromptTokens,
    candidatesTokenCount: totalCompletionTokens,
    totalTokenCount: totalPromptTokens + totalCompletionTokens,
  },
}
```

---

## ğŸ› é”™è¯¯å¤„ç†

### 1. ç½‘ç»œé”™è¯¯
```typescript
if (!response.ok) {
  throw new Error(`è±†åŒ…APIé”™è¯¯: ${response.status} ${errorText}`);
}
```

### 2. è§£æé”™è¯¯
```typescript
try {
  const chunk = JSON.parse(jsonStr);
  // å¤„ç†chunk...
} catch (parseError) {
  console.warn('è±†åŒ…æµå¼å“åº”è§£æé”™è¯¯:', parseError);
  // ç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œï¼Œä¸ä¸­æ–­æµ
}
```

### 3. ç©ºå“åº”å¤„ç†
```typescript
if (accumulatedText === '') {
  yield {
    candidates: [{
      content: { parts: [{ text: 'è±†åŒ…æ¨¡å‹å“åº”ä¸ºç©º' }] },
      finishReason: 'STOP',
    }],
  };
}
```

---

## âœ… éªŒè¯æµ‹è¯•

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯æµå¼è¾“å‡ºåŠŸèƒ½ï¼š

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
cd /Users/xiaogaiguo/GolandProjects/gemini/gemini-cli
npx vitest run packages/core/src/core/doubaoContentGenerator.test.ts

# é¢„æœŸè¾“å‡ºï¼š
# âœ“ packages/core/src/core/doubaoContentGenerator.test.ts (13 tests) 4ms
# Test Files  1 passed (1)
# Tests  13 passed (13)
```

---

## ğŸ‰ æ€»ç»“

è±†åŒ…æ¨¡å‹ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

1. âœ… **çœŸæ­£çš„æµå¼è¾“å‡º** - SSEå®æ—¶ä¼ è¾“
2. âœ… **æ™ºèƒ½Tokenè®¡æ•°** - ä¸­è‹±æ–‡æ··åˆä¼˜åŒ–
3. âœ… **å®Œæ•´çš„æµ‹è¯•è¦†ç›–** - 13ä¸ªæµ‹è¯•ç”¨ä¾‹
4. âœ… **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ** - ç±»ä¼¼ChatGPTçš„æ‰“å­—æœºæ•ˆæœ
5. âœ… **å¥å£®çš„é”™è¯¯å¤„ç†** - ç½‘ç»œã€è§£æã€ç©ºå“åº”

**ä¸é¡¹ç›®æ¶æ„å®Œç¾é›†æˆï¼š**
- éµå¾ª `ContentGenerator` æ¥å£
- å…¼å®¹ç°æœ‰çš„æ‰€æœ‰å·¥å…·å’Œä»£ç†
- æ”¯æŒæ—¥å¿—è®°å½•å’Œé¥æµ‹
- æ— ç¼åˆ‡æ¢ä¸åŒAIæ¨¡å‹

ç«‹å³ä½“éªŒè±†åŒ…æµå¼è¾“å‡ºçš„æµç•…ç¼–ç¨‹åŠ©æ‰‹ï¼ğŸš€
